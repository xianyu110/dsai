# 自动交易启用指南

## ⚠️ 重要警告

**自动交易将使用真实资金进行交易！请务必：**

1. ✅ 充分测试后再启用
2. ✅ 使用小额资金测试
3. ✅ 设置合理的交易金额（默认每次20 USDT）
4. ✅ 监控交易日志
5. ✅ 随时准备手动平仓

---

## 🔍 为什么AI分析有买入建议但不执行？

### 原因

**默认配置下，自动交易是禁用的**，这是安全保护机制。

代码检查逻辑（deepseek.py:438-440）：

```python
# 如果禁用自动交易,只显示分析结果
if not TRADE_CONFIG.get('auto_trade', False):
    print(f"⚠️ 自动交易已禁用,仅记录分析结果")
    return  # 不执行任何交易
```

### 工作流程

```
AI分析 → 给出建议（BUY/SELL/HOLD）
    ↓
检查 auto_trade 配置
    ↓
├─ False（禁用）→ 只记录分析结果，不交易 ❌
└─ True（启用） → 执行自动交易 ✅
```

---

## 🎯 如何启用自动交易？

### 方法1: 通过Web界面启用（推荐）

#### 步骤：

1. **打开Web界面**
   ```
   http://你的VPS_IP:8888
   ```

2. **找到自动交易开关**

   在页面顶部状态栏，找到：
   ```
   自动交易: [已停止] [启用]
   ```

3. **点击"启用"按钮**

   会弹出确认对话框：
   ```
   ⚠️ 启用自动交易后，系统将根据AI分析自动执行交易。

   确认要启用吗？
   ```

4. **确认启用**

   点击"确定"后，状态变为：
   ```
   自动交易: [运行中] [停止]
   ```

5. **验证**

   - 查看"交易操作日志"，应该看到 "✅ 自动交易已启用"
   - 等待下一次AI分析，如果有买入建议，会自动执行

#### 优点：
- ✅ 无需重启服务
- ✅ 立即生效
- ✅ 可以随时启用/停止
- ✅ 操作简单

---

### 方法2: 修改配置文件（需重启）

#### 步骤：

1. **编辑配置文件**

   ```bash
   nano deepseek.py
   ```

2. **找到第104行**

   修改前：
   ```python
   'auto_trade': False,  # ⚠️ 仅分析不自动交易
   ```

   修改后：
   ```python
   'auto_trade': True,   # ✅ 启用自动交易（请谨慎！）
   ```

3. **保存文件**

   - 按 `Ctrl + O` 保存
   - 按 `Enter` 确认
   - 按 `Ctrl + X` 退出

4. **重启服务**

   **如果使用Docker：**
   ```bash
   cd /opt/ai_tradeauto
   docker-compose restart
   ```

   **如果直接运行：**
   ```bash
   # 找到进程
   ps aux | grep web_ui.py

   # 杀死进程
   kill <PID>

   # 重新启动
   python web_ui.py &
   ```

5. **验证**

   查看日志：
   ```bash
   docker-compose logs -f
   ```

   或直接查看文件：
   ```bash
   tail -f logs/trading.log
   ```

#### 优点：
- ✅ 永久生效（重启也保持启用状态）
- ✅ 适合部署后长期运行

#### 缺点：
- ❌ 需要重启服务
- ❌ 重启期间服务不可用

---

## 📊 自动交易配置参数

### 当前配置（deepseek.py:98-106）

```python
TRADE_CONFIG = {
    'symbols': ['BTC/USDT', 'ETH/USDT', 'SOL/USDT', 'DOGE/USDT', 'BNB/USDT'],
    'amount_usd': 20,        # 每次交易20 USDT
    'leverage': 10,          # 默认10倍杠杆（根据AI信心度调整）
    'timeframe': '15m',      # 15分钟K线
    'test_mode': False,      # 实盘模式
    'auto_trade': True,      # 自动交易开关
    'hold_threshold': 0.95,  # 持仓止损阈值（95%）
}
```

### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `symbols` | 5个币种 | 监控的交易对列表 |
| `amount_usd` | 20 USDT | 每次开仓保证金（实际购买力 = 保证金 × 杠杆） |
| `leverage` | 10x | 杠杆倍数（根据AI信心度动态调整3x/5x/10x） |
| `timeframe` | 15m | K线周期 |
| `test_mode` | False | 是否测试模式（True=模拟，False=实盘） |
| `auto_trade` | **False** | **自动交易开关**（True=启用，False=禁用） |
| `hold_threshold` | 0.95 | 持仓止损阈值（价格低于入场价95%时平仓） |

### 杠杆动态调整策略

根据AI信心度自动调整杠杆（deepseek.py:507-514）：

```python
confidence = signal_data.get('confidence', 'MEDIUM').upper()
if confidence == 'HIGH':
    leverage = 10  # 高信心 10倍杠杆
elif confidence == 'MEDIUM':
    leverage = 5   # 中等信心 5倍杠杆
else:  # LOW
    leverage = 3   # 低信心 3倍杠杆
```

### 实际购买力计算

```python
保证金 = 20 USDT
杠杆 = 10x（根据信心度）
购买力 = 保证金 × 杠杆 = 20 × 10 = 200 USDT

# 例如：BTC价格 = 100,000 USDT
币数 = 200 / 100,000 = 0.002 BTC
```

---

## 🔄 自动交易执行逻辑

### 1. 无持仓时

```
AI分析 → 给出信号（BUY/SELL/HOLD）
    ↓
signal == BUY?
    ↓
YES → 开多仓
    - 根据信心度设置杠杆（3x/5x/10x）
    - 使用20 USDT保证金
    - 逐仓模式
    ↓
NO → signal == SELL?
    ↓
YES → 开空仓
    - 根据信心度设置杠杆
    - 使用20 USDT保证金
    - 逐仓模式
    ↓
NO → HOLD，不操作
```

### 2. 有持仓时

```
检查持仓价格比例
    ↓
多仓：当前价 / 入场价
空仓：入场价 / 当前价
    ↓
价格比例 < 95%?
    ↓
YES → 触发止损，平仓 🔴
    ↓
NO → 继续持有 ✅
```

**持仓优先原则**：有持仓时，**忽略AI新信号**，只根据价格止损。

---

## 📝 监控自动交易

### 1. 查看Web日志

访问Web界面 → "交易操作日志"

会显示：
- ✅ 开仓成功：BUY/SELL 信号
- ✅ 平仓成功：止损触发
- ❌ 操作失败：错误信息

### 2. 查看容器日志

```bash
cd /opt/ai_tradeauto
docker-compose logs -f
```

### 3. 查看实时分析

日志会显示：
```
================================================
🔄 开始新一轮自动交易分析 - 19:30:45
================================================

📊 分析 BTC/USDT...
当前价格: $108,472.92
价格变化: +0.25%
  📈 信号: BUY
  💪 信心: HIGH
  📝 理由: 强劲上涨趋势

📊 AI信心度: HIGH -> 杠杆: 10x
🟢 开多仓: 0.0018 张 BTC/USDT (杠杆: 10x)
✅ 开仓成功
```

### 4. 查看持仓

Web界面 → "合约持仓"

会显示：
- 币种
- 方向（多/空）
- 数量
- 开仓价
- 当前价
- 保证金
- 强平价
- 盈亏

---

## 🛑 如何停止自动交易？

### 方法1: Web界面（推荐）

1. 打开Web界面
2. 点击"停止"按钮
3. 确认停止

### 方法2: 修改配置文件

1. 编辑 `deepseek.py`
2. 修改 `'auto_trade': False`
3. 重启服务

### 紧急停止

```bash
# 停止Docker容器
docker-compose down

# 或强制停止进程
pkill -f web_ui.py
```

---

## ⚠️ 风险提示

### 自动交易风险

1. **市场风险**
   - 加密货币波动剧烈
   - 可能快速亏损
   - 强平风险

2. **技术风险**
   - API连接中断
   - 网络延迟
   - 系统故障

3. **策略风险**
   - AI分析可能错误
   - 止损可能被突破
   - 多币种同时亏损

### 安全建议

1. ✅ **从小额开始**
   - 建议每次交易金额 ≤ 20 USDT
   - 总投入 ≤ 账户余额的10%

2. ✅ **使用低杠杆**
   - 可以修改默认杠杆为3x或5x
   - 降低强平风险

3. ✅ **设置严格止损**
   - 默认95%已经较严格
   - 不建议低于90%

4. ✅ **密切监控**
   - 每小时检查一次持仓
   - 设置价格提醒
   - 准备随时手动平仓

5. ✅ **分散投资**
   - 不要全部资金都用于自动交易
   - 保持足够的保证金余额

---

## 📞 常见问题

### Q1: 启用后多久开始交易？

**A**: 下一次AI分析周期（默认15分钟）时，如果有买入/卖出信号且无持仓，就会执行交易。

### Q2: 会同时开多个币种的仓位吗？

**A**: 会！默认监控5个币种，如果多个币种都有买入信号，会分别开仓。

### Q3: 如何修改交易金额？

**A**: 修改 `deepseek.py` 的 `'amount_usd': 20` 为你想要的金额，重启服务。

### Q4: 如何只交易特定币种？

**A**: 修改 `deepseek.py` 的 `'symbols'` 列表，例如只交易BTC：
```python
'symbols': ['BTC/USDT'],
```

### Q5: 止损太严格，经常被平仓怎么办？

**A**: 修改 `'hold_threshold': 0.95` 为 `0.90`（止损10%）或更宽松的值。

### Q6: 如何启用测试模式？

**A**: 修改 `'test_mode': True`，会模拟交易但不实际下单。

---

## 🔗 相关文档

- [完整部署指南](GITHUB_DEPLOY.md)
- [Docker部署](README_DEPLOY.md)
- [VPS部署](VPS_DEPLOY_GUIDE.md)

---

**启用自动交易前，请务必充分理解风险！** ⚠️
